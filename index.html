<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mobile Lab Mityana ‚Äî Laboratory Report System</title>
  <meta name="description" content="Enter, preview, print and share client laboratory results for Mobile Lab Mityana (Uganda)." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            brand: {
              50: '#eefdf3', 100:'#d6f7e1', 200:'#b0efc7', 300:'#7de6a8', 400:'#4fd98a', 500:'#22c55e',
              600:'#16a34a', 700:'#15803d', 800:'#166534', 900:'#14532d'
            }
          }
        }
      }
    }
  </script>

  <!-- QRCode generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- ‚úÖ PWA Manifest + Theme -->
  <link rel="manifest" href="/labresultsmityana/manifest.json">
  <meta name="theme-color" content="#22c55e">

  <!-- ‚úÖ App Icons -->
  <link rel="icon" href="/labresultsmityana/icons/icon-192.png" sizes="192x192" type="image/png">
  <link rel="icon" href="/labresultsmityana/icons/icon-512.png" sizes="512x512" type="image/png">

  <!-- ‚úÖ iOS Support -->
  <link rel="apple-touch-icon" href="/labresultsmityana/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LabMityana">

  <style>
    @media print {
      #app { display: none; }
      #printable { display: block !important; }
      .no-print { display: none !important; }
      @page { size: A4; margin: 14mm; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- üîπ Your full app interface -->
  <div id="app" class="p-4 max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold text-brand-600 mb-4">Mobile Lab Mityana - Laboratory Report System</h1>

    <!-- Client & Sample Details -->
    <div class="bg-white p-4 rounded-2xl shadow mb-6">
      <h2 class="text-lg font-semibold mb-2">Client & Sample Details</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <input id="clientName" type="text" placeholder="Client Name" class="border p-2 rounded w-full">
        <input id="age" type="text" placeholder="Age" class="border p-2 rounded w-full">
        <input id="gender" type="text" placeholder="Gender" class="border p-2 rounded w-full">
        <input id="sampleId" type="text" placeholder="Sample ID" class="border p-2 rounded w-full">
      </div>
    </div>

    <!-- Test Selection -->
    <div class="bg-white p-4 rounded-2xl shadow mb-6">
      <h2 class="text-lg font-semibold mb-2">Select Tests</h2>
      <div class="grid md:grid-cols-3 gap-2">
        <label><input type="checkbox" value="Malaria RDT"> Malaria RDT</label>
        <label><input type="checkbox" value="CBC"> CBC</label>
        <label><input type="checkbox" value="Urinalysis"> Urinalysis</label>
        <label><input type="checkbox" value="HIV Test"> HIV Test</label>
        <label><input type="checkbox" value="COVID-19 Test"> COVID-19 Test</label>
        <label><input type="checkbox" value="Blood Sugar"> Blood Sugar</label>
      </div>
    </div>

    <!-- Results Input -->
    <div class="bg-white p-4 rounded-2xl shadow mb-6">
      <h2 class="text-lg font-semibold mb-2">Enter Results</h2>
      <textarea id="resultsInput" rows="6" class="border p-2 rounded w-full" placeholder="Enter results for the selected tests..."></textarea>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-2 mb-6">
      <button onclick="updatePreview()" class="px-4 py-2 bg-brand-500 text-white rounded-2xl shadow">Update Preview</button>
      <button onclick="window.print()" class="px-4 py-2 bg-blue-500 text-white rounded-2xl shadow">Print / Save PDF</button>
      <button onclick="saveDraft()" class="px-4 py-2 bg-gray-500 text-white rounded-2xl shadow">Save Draft</button>
      <button onclick="loadDraft()" class="px-4 py-2 bg-yellow-500 text-white rounded-2xl shadow">Load Draft</button>
      <button onclick="generateShareLink()" class="px-4 py-2 bg-green-500 text-white rounded-2xl shadow">Generate Share Link</button>
    </div>

    <!-- Preview -->
    <div class="bg-white p-4 rounded-2xl shadow">
      <h2 class="text-lg font-semibold mb-2">Preview Report</h2>
      <div id="previewArea" class="border p-4 rounded min-h-[200px]"></div>
      <div id="qrcode" class="mt-4"></div>
    </div>
  </div>

  <!-- Printable Area -->
  <div id="printable" style="display:none;"></div>

  <!-- üîπ Scripts -->
  <script>
    function updatePreview() {
      const name = document.getElementById("clientName").value;
      const age = document.getElementById("age").value;
      const gender = document.getElementById("gender").value;
      const sampleId = document.getElementById("sampleId").value;
      const results = document.getElementById("resultsInput").value;

      const preview = `
        <p><strong>Client:</strong> ${name}</p>
        <p><strong>Age:</strong> ${age}</p>
        <p><strong>Gender:</strong> ${gender}</p>
        <p><strong>Sample ID:</strong> ${sampleId}</p>
        <h3 class="font-semibold mt-2">Results:</h3>
        <p>${results.replace(/\n/g,"<br>")}</p>
      `;
      document.getElementById("previewArea").innerHTML = preview;
    }

    function saveDraft() {
      const draft = {
        name: document.getElementById("clientName").value,
        age: document.getElementById("age").value,
        gender: document.getElementById("gender").value,
        sampleId: document.getElementById("sampleId").value,
        results: document.getElementById("resultsInput").value
      };
      localStorage.setItem("labDraft", JSON.stringify(draft));
      alert("Draft saved!");
    }

    function loadDraft() {
      const draft = JSON.parse(localStorage.getItem("labDraft") || "{}");
      if (draft.name) {
        document.getElementById("clientName").value = draft.name;
        document.getElementById("age").value = draft.age;
        document.getElementById("gender").value = draft.gender;
        document.getElementById("sampleId").value = draft.sampleId;
        document.getElementById("resultsInput").value = draft.results;
        updatePreview();
      } else {
        alert("No draft found!");
      }
    }

    function generateShareLink() {
      const data = {
        n: document.getElementById("clientName").value,
        a: document.getElementById("age").value,
        g: document.getElementById("gender").value,
        s: document.getElementById("sampleId").value,
        r: document.getElementById("resultsInput").value
      };
      const encoded = encodeURIComponent(JSON.stringify(data));
      const url = window.location.origin + window.location.pathname + "#data=" + encoded;
      navigator.clipboard.writeText(url).then(() => {
        alert("Share link copied!");
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), url);
      });
    }

    window.addEventListener("load", () => {
      if (window.location.hash.startsWith("#data=")) {
        try {
          const data = JSON.parse(decodeURIComponent(window.location.hash.replace("#data=","")));
          document.getElementById("clientName").value = data.n || "";
          document.getElementById("age").value = data.a || "";
          document.getElementById("gender").value = data.g || "";
          document.getElementById("sampleId").value = data.s || "";
          document.getElementById("resultsInput").value = data.r || "";
          updatePreview();
        } catch(e) { console.error(e); }
      }
    });
  </script>

  <!-- ‚úÖ Service Worker Registration -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/labresultsmityana/service-worker.js", { scope: "/labresultsmityana/" })
          .then(reg => console.log("‚úÖ Service Worker registered:", reg))
          .catch(err => console.error("‚ùå Service Worker registration failed:", err));
      });
    }
  </script>
</body>
</html>

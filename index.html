<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Lab Mityana — Lab System</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f5f5f5;color:#333}
header{background:#005f73;color:#fff;padding:10px;text-align:center;font-size:1.5em;font-weight:bold}
.container{display:flex;flex-wrap:wrap;padding:10px;gap:20px}
.left,.right{background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
.left{flex:1 1 350px;max-width:400px;overflow:auto;max-height:90vh}
.right{flex:2 1 600px;max-height:90vh;overflow:auto}
h2{margin-top:0;color:#0a9396}
label.test-item{display:block;margin:4px 0}
.result-row{margin:6px 0}
.result-row input, .result-row select, .result-row textarea{width:100%;padding:4px;margin-top:2px;border-radius:4px;border:1px solid #ccc}
button{background:#0a9396;color:#fff;border:none;padding:6px 12px;margin:2px;border-radius:4px;cursor:pointer}
button:hover{background:#007f7f}
.table-container{overflow:auto}
table{width:100%;border-collapse:collapse;margin:10px 0}
table th, table td{border:1px solid #ccc;padding:4px;text-align:left}
.tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px}
.tab{padding:6px 12px;background:#94d2bd;border-radius:4px;cursor:pointer}
.tab.active{background:#0a9396;color:#fff}
.collapsible{margin-bottom:10px}
.collapsible h3{margin:0;padding:6px;background:#ee9b00;color:#fff;border-radius:4px;cursor:pointer}
.collapsible .content{display:none;padding:6px;background:#fff;border-radius:0 0 4px 4px;margin-top:2px;max-height:200px;overflow:auto}
.kv{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.kv div{flex:1 1 120px;background:#edf6f9;padding:6px;border-radius:4px}
.signs{display:flex;gap:20px;margin-top:10px}
.sigbox{border:1px solid #ccc;height:50px;padding:4px}
.stamp{margin-top:10px;background:#94d2bd;color:#fff;padding:6px;border-radius:4px;position:relative}
.stamp-date{position:absolute;top:6px;right:6px;font-size:0.8em}
.muted{color:#555;font-size:0.9em}
</style>
</head>
<body>
<header>Mobile Lab Mityana — Lab System</header>
<div class="container">
<div class="left">
<h2>Patient & Tests</h2>
<div>
<label>Name: <input id="clientName"/></label>
<label>Age: <input id="age" type="number"/></label>
<label>Gender: 
<select id="gender">
<option value="">Select</option>
<option>Male</option>
<option>Female</option>
<option>Other</option>
</select>
</label>
<label>Lab ID: <input id="sampleId" readonly/></label>
<label>Date: <input id="reportDate" type="date"/></label>
<label>Technician: <input id="technician"/></label>
</div>

<div class="tabs">
<div class="tab active" data-group="hematology">Hematology</div>
<div class="tab" data-group="biochemistry">Biochemistry</div>
<div class="tab" data-group="serology">Serology</div>
<div class="tab" data-group="infectious">Infectious</div>
<div class="tab" data-group="other">Other</div>
<div class="tab" data-group="panels">Panels</div>
</div>

<div id="testsContainer"></div>
<hr>
<button id="btnUpdate">Update Preview</button>
<button id="btnSave">Save Report</button>
<button id="btnView">View Reports</button>
<button id="btnDownload">Download PDF</button>
<div id="reportsContainer"></div>
</div>

<div class="right">
<h2>Report Preview</h2>
<div id="resultsContainer"><div class="muted">Tick tests to display inputs here.</div></div>
<div id="previewContainer"></div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
const byId=id=>document.getElementById(id);
const slug=s=>(s||'').toString().trim().replace(/[^a-z0-9]+/gi,'-').toLowerCase();

const GROUPS={hematology:["CBC – Complete Blood Count","BAT – Bleeding & Clotting Test","Blood Smear","Sickling Test"],
biochemistry:["Blood Glucose","Lipid Profile","Liver Function Test","Kidney Function Test","PSA"],
serology:["Pregnancy Test (hCG)","Rheumatoid Factor","RPR / Syphilis","H. Pylori Serum","H. Pylori Stool"],
infectious:["HIV","Hepatitis B","Hepatitis C","Brucella Test","Chlamydia Test","Gonorrhea Test","Malaria"],
other:["Blood Grouping","Stool Analysis","Urinalysis","Widal Serum","Widal Stool","Gram Staining","DNA"],
panels:["Electrolytes"]};

const CBC_FIELDS=["WBC","RBC","HBG","HCT","MCV","MCH","MCHC","PLT","LY","MO","GR","RDW-CV","RDW-SD","PCT","MPV","PDW","P-LCR"];
const CBC_UNITS={"WBC":"10⁹/L","RBC":"10¹²/L","HBG":"g/dL","HCT":"%","MCV":"fL","MCH":"pg","MCHC":"g/dL","PLT":"10⁹/L",
"LY":"%","MO":"%","GR":"%","RDW-CV":"%","RDW-SD":"fL","PCT":"%","MPV":"fL","PDW":"fL","P-LCR":"%"};

const CONFIG={"CBC – Complete Blood Count":{type:"cbc"},
"HIV":{type:"dropdown",options:["Negative","Positive"]},"Malaria":{type:"dropdown",options:["Negative","Positive"]},
"Hepatitis B":{type:"dropdown",options:["Negative","Positive"]},"Hepatitis C":{type:"dropdown",options:["Negative","Positive"]},
"Pregnancy Test (hCG)":{type:"dropdown",options:["Negative","Positive"]},"Brucella Test":{type:"dropdown",options:["Negative","Positive"]},
"H. Pylori Serum":{type:"dropdown",options:["Negative","Positive"]},"H. Pylori Stool":{type:"dropdown",options:["Negative","Positive"]},
"RPR / Syphilis":{type:"dropdown",options:["Non-reactive","Reactive"]},"Sickling Test":{type:"dropdown",options:["Negative","Positive"]},
"Blood Glucose":{type:"number",unit:"mmol/L"},"PSA":{type:"number",unit:"ng/mL"},"Blood Grouping":{type:"text",placeholder:"e.g., O+"},
"BAT – Bleeding & Clotting Test":{type:"text",placeholder:"BT: 2 min; CT: 6 min"},"Blood Smear":{type:"text",placeholder:"Morphology / comments"},
"Chlamydia Test":{type:"text",placeholder:"Result / notes"},"Gonorrhea Test":{type:"text",placeholder:"Result / notes"},"Stool Analysis":{type:"text",placeholder:"Macroscopy / Microscopy"},
"Urinalysis":{type:"text",placeholder:"Appearance, pH, proteins, etc."},"Widal Serum":{type:"text",placeholder:"Titers..."},"Widal Stool":{type:"text",placeholder:"Findings..."},
"Gram Staining":{type:"text",placeholder:"Gram +/-; morphology..."},"DNA":{type:"text",placeholder:"Notes..."},"Electrolytes":{type:"textarea",placeholder:"Na⁺ / K⁺ / Cl⁻ / HCO₃⁻ etc."},
"Lipid Profile":{type:"textarea",placeholder:"TC, HDL, LDL, TG ..."},"Liver Function Test":{type:"textarea",placeholder:"ALT, AST, ALP, TBil ..."},
"Kidney Function Test":{type:"textarea",placeholder:"Urea, Creatinine ..."},"Rheumatoid Factor":{type:"text",placeholder:"Value or qualitative"}};

/* ---------- Tabs ---------- */
document.querySelectorAll('.tab').forEach(tab=>{
tab.addEventListener('click',()=>{
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
tab.classList.add('active'); showGroupTests(tab.dataset.group);
});
});

/* ---------- Populate Group Tests ---------- */
function showGroupTests(group){
const container=byId('testsContainer'); container.innerHTML='';
GROUPS[group].forEach(test=>{
const wrap=document.createElement('label'); wrap.className='test-item';
wrap.innerHTML=`<input type="checkbox" data-test="${test}"/> ${test}`;
container.appendChild(wrap);
wrap.querySelector('input').addEventListener('change',renderResultInputs);
});
}

/* ---------- Render Inputs ---------- */
function renderResultInputs(){
const container=byId('resultsContainer'); container.innerHTML='';
const checked=[...document.querySelectorAll('input[type=checkbox][data-test]:checked')].map(i=>i.dataset.test);
if(!checked.length){container.innerHTML='<div class="muted">Tick tests above — their result inputs will appear here.</div>';return;}
checked.forEach(test=>{
const cfg=CONFIG[test]||{type:'text'};
if(cfg.type==='cbc'){
let html='<h3>CBC — Complete Blood Count</h3><table><thead><tr><th>Parameter</th><th>Result</th><th>Unit</th><th>Reference</th></tr></thead><tbody>';
CBC_FIELDS.forEach(f=>{
const idRes=`res-${slug(test)}-${slug(f)}`; const idRef=`ref-${slug(test)}-${slug(f)}`;
html+=`<tr><td>${f}</td><td><input id="${idRes}"/></td><td>${CBC_UNITS[f]}</td><td><input id="${idRef}" placeholder="4.0-11.0"/></td></tr>`;
});
html+='</tbody></table>'; container.insertAdjacentHTML('beforeend',html); return;
}
const id=`res-${slug(test)}`;
if(cfg.type==='dropdown'){let options='<option value="">Select</option>'; cfg.options.forEach(o=>options+=`<option>${o}</option>`); container.insertAdjacentHTML('beforeend',`<div class="result-row"><b>${test}</b><br><select id="${id}">${options}</select></div>`);return;}
if(cfg.type==='number'){container.insertAdjacentHTML('beforeend',`<div class="result-row"><b>${test}</b><br><div style="display:flex;gap:8px;align-items:center"><input id="${id}" type="number" step="any"/><span class="unit">${cfg.unit||''}</span><input id="ref-${slug(test)}" placeholder="Reference range"/></div></div>`);return;}
if(cfg.type==='textarea'){container.insertAdjacentHTML('beforeend',`<div class="result-row"><b>${test}</b><br><textarea id="${id}" placeholder="${cfg.placeholder||''}"></textarea></div>`);return;}
container.insertAdjacentHTML('beforeend',`<div class="result-row"><b>${test}</b><br><input id="${id}" placeholder="${cfg.placeholder||''}"/></div>`);
});
}

/* ---------- Collect & Preview ---------- */
function collectResults(){
const checked=[...document.querySelectorAll('input[type=checkbox][data-test]:checked')].map(i=>i.dataset.test);
const rows=[];
checked.forEach(test=>{
const cfg=CONFIG[test]||{type:'text'};
if(cfg.type==='cbc'){const table=CBC_FIELDS.map(f=>({param:f,val:byId(`res-${slug(test)}-${slug(f)}`)?.value||'—',unit:CBC_UNITS[f],ref:byId(`ref-${slug(test)}-${slug(f)}`)?.value||'—'})); rows.push({test,type:'cbc',table}); return;}
const id=`res-${slug(test)}`; rows.push({test,type:cfg.type,result:byId(id)?.value||'—',unit:cfg.unit||''});
});
return rows;
}

function updatePreview(){
const name=byId('clientName').value||'—'; const age=byId('age').value||'—';
const gender=byId('gender').value||'—'; const sample=byId('sampleId').value||'—';
const tech=byId('technician').value||'—'; const date=byId('reportDate').value||new Date().toLocaleDateString();
const rows=collectResults();
let html=`<div class="kv"><div><b>Client</b>${name}</div><div><b>Age/Gender</b>${age}/${gender}</div><div><b>Lab ID</b>${sample}</div><div><b>Date</b>${date}</div></div>`;
rows.forEach(r=>{
if(r.type==='cbc'){html+=`<h3>${r.test}</h3><table><thead><tr><th>Parameter</th><th>Result</th><th>Unit</th><th>Reference</th></tr></thead><tbody>`; r.table.forEach(t=>{html+=`<tr><td>${t.param}</td><td>${t.val}</td><td>${t.unit}</td><td>${t.ref}</td></tr>`;}); html+='</tbody></table>'; return;}
html+=`<p><b>${r.test}:</b> ${r.result} ${r.unit? '('+r.unit+')':''}</p>`;
});
html+=`<div class="signs"><div><b>Technician</b><div class="sigbox">${tech}</div></div><div><b>Signature</b><div class="sigbox"></div></div></div>
<div class="stamp">DIAGNOSIS AT YOUR DOORSTEP<br>0750992939 / 0778379591<div class="stamp-date">Date: ${date}</div></div>
<div class="footnote muted">Report generated by Mobile Lab Mityana. For clinical correlation only.</div>`;
byId('previewContainer').innerHTML=html;
}

/* ---------- Save & Reports ---------- */
function saveReport(){
const rows=collectResults();
const report={id:byId('sampleId').value,date:byId('reportDate').value,name:byId('clientName').value,age:byId('age').value,gender:byId('gender').value,technician:byId('technician').value,results:rows};
let data=JSON.parse(localStorage.getItem('mlm_reports_v1')||'[]'); data.push(report);
localStorage.setItem('mlm_reports_v1',JSON.stringify(data));
alert('Report saved!'); showReports();
}

function showReports(){
const container=byId('reportsContainer'); let data=JSON.parse(localStorage.getItem('mlm_reports_v1')||'[]');
if(!data.length){container.innerHTML='<p class="muted">No reports saved yet.</p>'; return;}
let html=`<div class="table-container"><table><thead><tr><th>Lab ID</th><th>Name</th><th>Date</th><th>Actions</th></tr></thead><tbody>`;
data.forEach((r,i)=>{html+=`<tr><td>${r.id}</td><td>${r.name}</td><td>${r.date}</td><td><button onclick="loadReport(${i})">View</button> <button onclick="deleteReport(${i})">Delete</button></td></tr>`;});
html+='</tbody></table></div>'; container.innerHTML=html;
}

function loadReport(index){
let data=JSON.parse(localStorage.getItem('mlm_reports_v1')||'[]'); if(!data[index])return;
const r=data[index]; byId('clientName').value=r.name; byId('age').value=r.age; byId('gender').value=r.gender;
byId('sampleId').value=r.id; byId('reportDate').value=r.date; byId('technician').value=r.technician;
document.querySelectorAll('input[type=checkbox][data-test]').forEach(cb=>cb.checked=false);
r.results.forEach(res=>{const cb=document.querySelector(`input[type=checkbox][data-test="${res.test}"]`); if(cb)cb.checked=true;});
renderResultInputs();
r.results.forEach(res=>{if(res.type==='cbc'){res.table.forEach(t=>{const id=`res-${slug(res.test)}-${slug(t.param)}`; const ref=`ref-${slug(res.test)}-${slug(t.param)}`;
if(byId(id))byId(id).value=t.val; if(byId(ref))byId(ref).value=t.ref;}); return;}
const id=`res-${slug(res.test)}`; if(byId(id))byId(id).value=res.result;});
updatePreview();
}

function deleteReport(index){
if(!confirm('Delete this report?')) return;
let data=JSON.parse(localStorage.getItem('mlm_reports_v1')||'[]'); data.splice(index,1); localStorage.setItem('mlm_reports_v1',JSON.stringify(data));
showReports();
}

/* ---------- PDF ---------- */
function downloadPDF(){ const element=byId('previewContainer'); if(!element) return;
const opt={margin:0.2, filename:`${byId('sampleId').value}.pdf`, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'}};
html2pdf().set(opt).from(element).save();
}

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded',()=>{
byId('reportDate').value=new Date().toISOString().slice(0,10);
let counter=parseInt(localStorage.getItem('mlm_lab_counter_v1')||'0',10)+1; localStorage.setItem('mlm_lab_counter_v1',counter);
const ymd=new Date().toISOString().slice(0,10).replace(/-/g,''); byId('sampleId').value=`MLM-${ymd}-${String(counter).padStart(4,'0')}`;
byId('btnUpdate').addEventListener('click',updatePreview);
byId('btnSave').addEventListener('click',saveReport);
byId('btnView').addEventListener('click',showReports);
byId('btnDownload').addEventListener('click',downloadPDF);
showGroupTests('hematology');
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile Lab Mityana — Laboratory Report System</title>

  <!-- ✅ PWA additions -->
  <link rel="manifest" href="/labresultsmityana/manifest.json">
  <meta name="theme-color" content="#22c55e">
  <link rel="icon" href="/labresultsmityana/icons/icon-192.png" sizes="192x192" type="image/png">
  <link rel="icon" href="/labresultsmityana/icons/icon-512.png" sizes="512x512" type="image/png">
  <link rel="apple-touch-icon" href="/labresultsmityana/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LabMityana">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">

  <header class="bg-green-500 text-white p-4 flex items-center">
    <div class="font-bold text-lg">Mobile Lab Mityana — Laboratory Report System</div>
  </header>

  <main class="p-4 max-w-6xl mx-auto space-y-6">

    <!-- Client & Sample Details -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-bold text-lg mb-2">Client & Sample Details</h2>
      <div class="grid md:grid-cols-2 gap-3">
        <input id="clientName" type="text" placeholder="Client Name" class="border rounded p-2 w-full">
        <input id="age" type="number" placeholder="Age" class="border rounded p-2 w-full">
        <input id="gender" type="text" placeholder="Gender" class="border rounded p-2 w-full">
        <input id="sampleId" type="text" placeholder="Sample ID" class="border rounded p-2 w-full">
      </div>
    </section>

    <!-- Tests -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-bold text-lg mb-2">Select Tests</h2>
      <div id="testsList" class="grid md:grid-cols-3 gap-2 text-sm">
        <!-- ✅ Predefined test checkboxes -->
        <label><input type="checkbox" class="mr-2 test-option" value="BAT – Bleeding & Clotting Test">BAT – Bleeding & Clotting Test</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Blood Glucose">Blood Glucose</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Blood Grouping">Blood Grouping</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Blood Smear">Blood Smear</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Brucella Test">Brucella Test</label>
        <label><input type="checkbox" class="mr-2 test-option" value="CBC – Complete Blood Count">CBC – Complete Blood Count</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Chlamydia Test">Chlamydia Test</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Electrolytes">Electrolytes</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Gonorrhea Test">Gonorrhea Test</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Pregnancy Test (hCG)">Pregnancy Test (hCG)</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Hepatitis B">Hepatitis B</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Hepatitis C">Hepatitis C</label>
        <label><input type="checkbox" class="mr-2 test-option" value="HIV">HIV</label>
        <label><input type="checkbox" class="mr-2 test-option" value="H. Pylori Serum">H. Pylori Serum</label>
        <label><input type="checkbox" class="mr-2 test-option" value="H. Pylori Stool">H. Pylori Stool</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Lipid Profile">Lipid Profile</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Liver Function Test">Liver Function Test</label>
        <label><input type="checkbox" class="mr-2 test-option" value="PSA">PSA</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Kidney Function Test">Kidney Function Test</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Rheumatoid Factor">Rheumatoid Factor</label>
        <label><input type="checkbox" class="mr-2 test-option" value="RPR / Syphilis">RPR / Syphilis</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Stool Analysis">Stool Analysis</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Urinalysis">Urinalysis</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Widal Serum">Widal Serum</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Widal Stool">Widal Stool</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Gram Staining">Gram Staining</label>
        <label><input type="checkbox" class="mr-2 test-option" value="DNA">DNA</label>
        <label><input type="checkbox" class="mr-2 test-option" value="Sickling Test">Sickling Test</label>
      </div>

      <!-- ✅ Custom test field -->
      <div class="flex items-center gap-2 mt-3">
        <input id="customTest" type="text" placeholder="Enter custom test" class="border rounded p-2 w-full">
        <button onclick="addCustomTest()" class="bg-green-500 text-white px-4 py-2 rounded-xl shadow hover:bg-green-600">Add</button>
      </div>
    </section>

    <!-- Results -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-bold text-lg mb-2">Enter Results</h2>
      <textarea id="results" rows="4" class="border rounded p-2 w-full" placeholder="Enter results for the selected tests..."></textarea>
    </section>

    <!-- Buttons -->
    <div class="flex flex-wrap gap-2">
      <button onclick="updatePreview()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl shadow">Update Preview</button>
      <button onclick="printReport()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl shadow">Print / Save PDF</button>
      <button onclick="saveDraft()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-xl shadow">Save Draft</button>
      <button onclick="loadDraft()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-xl shadow">Load Draft</button>
      <button onclick="generateShareLink()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-xl shadow">Generate Share Link</button>
    </div>

    <!-- Preview -->
    <section class="bg-white rounded-2xl shadow p-4" id="preview">
      <h2 class="font-bold text-lg mb-2">Report Preview</h2>
      <div id="previewContent" class="text-sm text-slate-700">Fill details and click "Update Preview".</div>
    </section>
  </main>

  <!-- ✅ App Logic -->
  <script>
    function updatePreview() {
      const name = clientName.value;
      const ageVal = age.value;
      const genderVal = gender.value;
      const sampleIdVal = sampleId.value;
      const resultsVal = results.value;
      const tests = Array.from(document.querySelectorAll('.test-option:checked')).map(cb => cb.value);

      document.getElementById('previewContent').innerHTML = `
        <p><strong>Client:</strong> ${name || '-'} (${ageVal || '-'} / ${genderVal || '-'})</p>
        <p><strong>Sample ID:</strong> ${sampleIdVal || '-'}</p>
        <p><strong>Tests:</strong> ${tests.join(', ') || 'None'}</p>
        <p><strong>Results:</strong> ${resultsVal || '-'}</p>
      `;
    }

    function addCustomTest() {
      const customInput = document.getElementById('customTest');
      const val = customInput.value.trim();
      if (!val) return;
      const container = document.getElementById('testsList');
      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" class="mr-2 test-option" value="${val}">${val}`;
      container.appendChild(label);
      customInput.value = '';
    }

    function printReport() { window.print(); }

    function saveDraft() {
      const data = {
        name: clientName.value,
        age: age.value,
        gender: gender.value,
        sampleId: sampleId.value,
        results: results.value,
        tests: Array.from(document.querySelectorAll('.test-option:checked')).map(cb => cb.value)
      };
      localStorage.setItem('labDraft', JSON.stringify(data));
      alert("Draft saved!");
    }

    function loadDraft() {
      const data = JSON.parse(localStorage.getItem('labDraft') || '{}');
      if (!data.name) return alert("No draft found");
      clientName.value = data.name;
      age.value = data.age;
      gender.value = data.gender;
      sampleId.value = data.sampleId;
      results.value = data.results;
      document.querySelectorAll('.test-option').forEach(cb => cb.checked = data.tests.includes(cb.value));
      updatePreview();
    }

    function generateShareLink() {
      const data = {
        n: clientName.value,
        a: age.value,
        g: gender.value,
        s: sampleId.value,
        r: results.value,
        t: Array.from(document.querySelectorAll('.test-option:checked')).map(cb => cb.value)
      };
      const link = location.origin + location.pathname + '#' + btoa(JSON.stringify(data));
      navigator.clipboard.writeText(link).then(() => alert("Share link copied!"));
    }

    // Load from share link if exists
    window.addEventListener('load', () => {
      if (location.hash.length > 1) {
        try {
          const data = JSON.parse(atob(location.hash.substring(1)));
          clientName.value = data.n || "";
          age.value = data.a || "";
          gender.value = data.g || "";
          sampleId.value = data.s || "";
          results.value = data.r || "";
          document.querySelectorAll('.test-option').forEach(cb => cb.checked = (data.t || []).includes(cb.value));
          updatePreview();
        } catch(e) { console.warn("Invalid share link"); }
      }
    });
  </script>

  <!-- ✅ Service Worker Registration -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/labresultsmityana/service-worker.js", { scope: "/labresultsmityana/" })
          .then(reg => console.log("✅ Service Worker registered:", reg))
          .catch(err => console.error("❌ Service Worker registration failed:", err));
      });
    }
  </script>
</body>
</html>

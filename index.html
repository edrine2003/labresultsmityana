<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mobile Lab Mityana — Laboratory Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
:root { --brand:#22c55e; --ink:#0f172a; --muted:#475569; --bg:#f1f5f9; --card:#fff; --border:#e2e8f0; }
*{box-sizing:border-box;}
body{margin:0;font-family:ui-sans-serif,system-ui,sans-serif;color:var(--ink);background:var(--bg);}
header{background:var(--brand);color:#fff;padding:12px 18px;}
header .title{font-weight:800;}
main{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;gap:16px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;}
h2{margin:0 0 10px;font-size:18px;}
.grid{display:grid;gap:10px;}
.g2{grid-template-columns:repeat(2,minmax(0,1fr));}
.g3{grid-template-columns:repeat(3,minmax(0,1fr));}
label small{color:var(--muted);display:block;margin-top:4px;}
input[type=text], input[type=number], select, textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--ink);}
textarea{min-height:80px;}
.tests{columns:320px;column-gap:18px;}
.test-item{break-inside:avoid;display:flex;align-items:center;gap:8px;margin:6px 0;}
.btns{display:flex;flex-wrap:wrap;gap:8px;}
.btn{background:var(--brand);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;}
.btn.alt{background:#2563eb;}
.btn.ghost{background:#0f172a;}
.muted{color:var(--muted);}
.results-wrap{display:grid;gap:10px;}
.result-row{display:grid;grid-template-columns:1.2fr 1fr;gap:10px;align-items:center;}
.unit{color:var(--muted);margin-left:6px;font-size:10px;}
#previewCard{padding:0;overflow:hidden;}
.rep-head{padding:16px;border-bottom:1px solid var(--border);display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:12px;}
.rep-title{font-weight:800;font-size:20px;line-height:1.1;}
.rep-sub{color:var(--muted);font-size:12px;}
.rep-logo{width:56px;height:56px;border-radius:12px;border:1px solid var(--border);object-fit:cover;}
.rep-body{padding:16px;}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px;margin-bottom:12px;}
.kv div{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:10px 12px;}
.kv b{display:block;font-size:12px;color:var(--muted);margin-bottom:4px;}
table{width:100%;border-collapse:collapse;margin-bottom:10px;font-size:12px;}
th, td{border:1px solid var(--border);padding:6px 8px;text-align:center;}
th{background:#f8fafc;}
tbody tr:nth-child(even){background:#f8fafc;}
tbody tr:nth-child(odd){background:#fff;}
.signs{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;}
.sigbox{height:64px;border:1px dashed var(--border);border-radius:10px;padding:0;background:#fff;cursor:crosshair;width:100%;}
.footnote{margin-top:10px;font-size:12px;color:var(--muted);}
.stamp{border:4px solid #1e40af;color:#1e40af;padding:8px;text-align:center;margin-top:20px;border-radius:6px;width:250px;font-weight:700;}
.stamp-date{margin-top:5px;font-size:12px;}
@media (max-width:780px){.g2,.g3{grid-template-columns:1fr;}.kv{grid-template-columns:1fr;}.rep-head{grid-template-columns:auto 1fr;}}
@media print{@page{size:A4;margin:14mm;}header,.card.form,.btns{display:none !important;}body{background:#fff;}#previewCard{border:none;}}
</style>
</head>
<body>
<header>
<div class="title">Mobile Lab Mityana — Laboratory Report System</div>
</header>
<main>
<section class="card form">
<h2>Client & Sample Details</h2>
<div class="grid g3">
<label>Client Name<input id="clientName" type="text" placeholder="e.g., John Doe"/></label>
<label>Age<input id="age" type="number" placeholder="e.g., 32"/></label>
<label>Gender<select id="gender"><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select></label>
</div>
<div class="grid g3" style="margin-top:10px">
<label>Sample ID<input id="sampleId" type="text" placeholder="e.g., S-2025-001"/></label>
<label>Technician<select id="technician"><option value="">Select Technician</option><option>Maweda Edrine</option><option>Matovu Timothy</option></select></label>
<label>Date (auto)<input id="reportDate" type="text" disabled/></label>
</div>
</section>

<section class="card form">
<h2>Select Tests</h2>
<div id="testsList" class="tests"></div>
<div style="margin-top:10px" class="grid g2">
<label>Add Custom Test<input id="customTest" type="text"/></label>
<button class="btn" id="btnAddCustom">Add Custom Test</button>
</div>
</section>

<section class="card form">
<h2>Enter Results</h2>
<div id="resultsContainer" class="results-wrap">
<div class="muted">Tick tests above — their result inputs will appear here.</div>
</div>
<div class="btns" style="margin-top:10px">
<button id="btnUpdate" class="btn">Update Preview</button>
<button id="btnDownload" class="btn alt">Download PDF</button>
<button id="btnSave" class="btn ghost">Save Report</button>
<button id="btnView" class="btn">View Saved Reports</button>
<button id="btnExport" class="btn">Export Backup</button>
<label class="btn alt" style="cursor:pointer">Import Backup
<input type="file" id="importFile" style="display:none"/>
</label>
</div>
</section>

<section id="previewCard" class="card">
<div class="rep-head">
<img class="rep-logo" src="/mobile-lab-mityana-ug/icons/icon-192.png" alt="Lab Logo"/>
<div>
<div class="rep-title">Mobile Lab Mityana – Laboratory Report</div>
<div class="rep-sub">Mityana, Uganda</div>
</div>
<div class="muted">Installable PWA</div>
</div>
<div class="rep-body" id="reportPreview">
<p class="muted">Fill details and click <b>Update Preview</b>.</p>
</div>
</section>
</main>

<script>
const TESTS=["BAT – Bleeding & Clotting Test","Blood Glucose","Blood Grouping","Blood Smear","Brucella Test","CBC – Complete Blood Count","Chlamydia Test","Electrolytes","Gonorrhea Test","Pregnancy Test (hCG)","Hepatitis B","Hepatitis C","HIV","H. Pylori Serum","H. Pylori Stool","Lipid Profile","Liver Function Test","PSA","Kidney Function Test","Rheumatoid Factor","RPR / Syphilis","Stool Analysis","Urinalysis","Widal Serum","Widal Stool","Gram Staining","DNA","Sickling Test","Malaria"];

const CONFIG={
"HIV":{type:"dropdown",options:["Negative","Positive"]},
"Malaria":{type:"dropdown",options:["Negative","Positive"]},
"Hepatitis B":{type:"dropdown",options:["Negative","Positive"]},
"Hepatitis C":{type:"dropdown",options:["Negative","Positive"]},
"Pregnancy Test (hCG)":{type:"dropdown",options:["Negative","Positive"]},
"Brucella Test":{type:"dropdown",options:["Negative","Positive"]},
"H. Pylori Serum":{type:"dropdown",options:["Negative","Positive"]},
"H. Pylori Stool":{type:"dropdown",options:["Negative","Positive"]},
"RPR / Syphilis":{type:"dropdown",options:["Non-reactive","Reactive"]},
"Sickling Test":{type:"dropdown",options:["Negative","Positive"]},
"Blood Glucose":{type:"number",unit:"mmol/L"},
"CBC – Complete Blood Count":{type:"group",fields:["RBC","Hb","Hct","MCV","MCH","MCHC","RDW","Retic","WBC","Neut%","Neut#","Lymph%","Lymph#","Mono%","Mono#","Eos%","Eos#","Baso%","Baso#","IG%","PLT","MPV","PDW","Large PLT","NLR"],units:{RBC:"10¹²/L",Hb:"g/dL",Hct:"%",MCV:"fL",MCH:"pg",MCHC:"g/dL",RDW:"%",Retic:"%",WBC:"10⁹/L","Neut%":"%","Neut#":"10⁹/L","Lymph%":"%","Lymph#":"10⁹/L","Mono%":"%","Mono#":"10⁹/L","Eos%":"%","Eos#":"10⁹/L","Baso%":"%","Baso#":"10⁹/L","IG%":"%","PLT":"10⁹/L","MPV":"fL","PDW":"fL","Large PLT":"%","NLR":"ratio"}}};

// --- Encryption key
const ENCRYPT_KEY="labmityana2025";

const byId=id=>document.getElementById(id);
const slug=s=>s.replace(/[^a-z0-9]+/gi,'-').toLowerCase();

// Populate tests list
const testsList=byId('testsList');
TESTS.forEach(test=>{
  const id='t_'+slug(test);
  const wrap=document.createElement('label');
  wrap.className='test-item';
  wrap.innerHTML=`<input type="checkbox" id="${id}" data-test="${test}"/> ${test}`;
  testsList.appendChild(wrap);
});

// Auto date
const dateEl=byId('reportDate');
dateEl.value=new Date().toLocaleDateString();

// Render result inputs
function renderResultInputs(){
  const container=byId('resultsContainer'); container.innerHTML='';
  const checked=[...testsList.querySelectorAll('input[type=checkbox]:checked')];
  if(!checked.length){container.innerHTML='<div class="muted">Tick tests above — their result inputs will appear here.</div>'; return;}
  checked.forEach(cb=>{
    const testName=cb.dataset.test; const cfg=CONFIG[testName]||{type:'text'};
    const row=document.createElement('div'); row.className='result-row';
    const label=document.createElement('div'); label.innerHTML=`<b>${testName}</b>`;
    const field=document.createElement('div'); let inputHtml=''; const baseId='res_'+slug(testName);

    if(cfg.type==='dropdown'){
      inputHtml=`<select id="${baseId}"><option value="">Select</option>${cfg.options.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
    } else if(cfg.type==='number'){
      inputHtml=`<div style="display:flex;align-items:center;gap:6px"><input id="${baseId}" type="number" step="any"/><span class="unit">${cfg.unit||''}</span></div>`;
    } else if(cfg.type==='group'){
      inputHtml='<table><thead><tr>'+cfg.fields.map(f=>`<th>${f}<br><span style="font-size:10px;color:#555">${cfg.units[f]||""}</span></th>`).join('')+'</tr></thead><tbody><tr>'+cfg.fields.map(f=>`<td><input type="number" id="${baseId+'-'+slug(f)}"/></td>`).join('')+'</tr></tbody></table>';
    } else{
      inputHtml=`<input id="${baseId}" type="text" placeholder="${cfg.placeholder||'Enter result'}"/>`;
    }

    field.innerHTML=inputHtml; row.appendChild(label); row.appendChild(field); container.appendChild(row);
  });
}

// Collect results + signatures
function collectResults(){
  const checked=[...testsList.querySelectorAll('input[type=checkbox]:checked')]; 
  const rows=[];
  checked.forEach(cb=>{
    const testName=cb.dataset.test; const cfg=CONFIG[testName]||{type:'text'};
    if(cfg.type==='group'){
      const values=cfg.fields.map(f=>{
        const el=byId('res_'+slug(testName)+'-'+slug(f));
        return `${f}: ${el?el.value||'—':''}`;
      }).join('; ');
      rows.push({test:testName,result:values});
    } else{
      const el=byId('res_'+slug(testName)); const val=el?el.value||'—':'—'; const unit=cfg.unit?` ${cfg.unit}`:''; 
      rows.push({test:testName,result:val+unit});
    }
  });
  // Signatures
  const techCanvas = byId('techSig');
  const clientCanvas = byId('clientSig');
  const techSig = techCanvas ? techCanvas.toDataURL() : '';
  const clientSig = clientCanvas ? clientCanvas.toDataURL() : '';
  return {results: rows, techSig, clientSig};
}

// Update preview
function updatePreview(){
  const name=byId('clientName').value||'—';
  const age=byId('age').value||'—';
  const gender=byId('gender').value||'—';
  const sample=byId('sampleId').value||'—';
  const tech=byId('technician').value||'—';
  const date=byId('reportDate').value||new Date().toLocaleDateString();
  const {results,techSig,clientSig}=collectResults();
  const tableHtml=`<table><thead><tr><th style="width:55%">Test</th><th>Result</th></tr></thead><tbody>${results.length?results.map(r=>`<tr><td>${r.test}</td><td>${r.result||'<span class="muted">—</span>'}</td></tr>`).join(''):`<tr><td colspan="2" class="muted">No tests selected</td></tr>`}</tbody></table>`;

  byId('reportPreview').innerHTML=`<div class="kv">
    <div><b>Client</b>${name}</div>
    <div><b>Age / Gender</b>${age} / ${gender}</div>
    <div><b>Sample ID</b>${sample}</div>
    <div><b>Date</b>${date}</div>
  </div>
  <h3 style="margin:0 0 8px">Tests Performed</h3>
  ${tableHtml}
  <div class="signs">
    <div><b>Technician</b><canvas id="techSig" class="sigbox"></canvas></div>
    <div><b>Client Signature</b><canvas id="clientSig" class="sigbox"></canvas></div>
  </div>
  <div class="stamp">
    DIAGNOSIS AT YOUR DOORSTEP<br>
    0750992939 / 0778379591
    <div class="stamp-date">Date: ${date}</div>
  </div>
  <div class="footnote">Report generated by Mobile Lab Mityana. For clinical correlation only.</div>`;

  initSignature('techSig'); initSignature('clientSig');
}

// Initialize signature canvas
function initSignature(canvasId){
  const canvas=byId(canvasId); const ctx=canvas.getContext('2d');
  let drawing=false;
  canvas.addEventListener('mousedown', e=>{drawing=true; ctx.beginPath(); ctx.moveTo(e.offsetX,e.offsetY);});
  canvas.addEventListener('mousemove', e=>{if(drawing){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();}});
  canvas.addEventListener('mouseup', ()=>drawing=false);
  canvas.addEventListener('mouseout', ()=>drawing=false);
  ctx.lineWidth=2; ctx.strokeStyle="#000";
}

// Save report with encryption
function saveReport(){ 
  const data=JSON.parse(localStorage.getItem('labReports')||'[]');
  const report=collectResults();
  report.client=byId('clientName').value||'—';
  report.sample=byId('sampleId').value||'—';
  report.date=byId('reportDate').value||new Date().toLocaleDateString();
  const ciphertext=CryptoJS.AES.encrypt(JSON.stringify(report),ENCRYPT_KEY).toString();
  data.push(ciphertext);
  localStorage.setItem('labReports',JSON.stringify(data));
  alert('✅ Report saved with signatures (encrypted).');
}

// View saved reports
function viewReport(index){
  const data=JSON.parse(localStorage.getItem('labReports')||'[]'); if(!data[index]) return alert('Not found');
  const decrypted=JSON.parse(CryptoJS.AES.decrypt(data[index],ENCRYPT_KEY).toString(CryptoJS.enc.Utf8));
  let html=`<h2>${decrypted.client} | ${decrypted.sample} | ${decrypted.date}</h2><table border="1" cellspacing="0" cellpadding="6"><tr><th>Test</th><th>Result</th></tr>`;
  decrypted.results.forEach(r=>html+=`<tr><td>${r.test}</td><td>${r.result}</td></tr>`);
  html+='</table>';
  if(decrypted.techSig) html+=`<h3>Technician Signature</h3><img src="${decrypted.techSig}" style="border:1px dashed #000;width:300px;height:64px"/>`;
  if(decrypted.clientSig) html+=`<h3>Client Signature</h3><img src="${decrypted.clientSig}" style="border:1px dashed #000;width:300px;height:64px"/>`;
  const win=window.open('','_blank'); win.document.write(html); win.document.close();
}
function showReports(){
  const data=JSON.parse(localStorage.getItem('labReports')||'[]'); if(!data.length){alert('No saved reports'); return;}
  let msg=''; data.forEach((c,i)=>{try{const r=JSON.parse(CryptoJS.AES.decrypt(c,ENCRYPT_KEY).toString(CryptoJS.enc.Utf8)); msg+=`${i+1}. ${r.client} | ${r.sample} | ${r.date}\n`; }catch(e){ msg+=`${i+1}. [Error]\n`; }});
  const choice=prompt(msg+"\nEnter report number to view:"); const index=parseInt(choice)-1; if(!isNaN(index)) viewReport(index);
}

// Export / import backup
function exportBackup(){ const data=localStorage.getItem('labReports')||'[]'; const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='labBackup.json'; a.click();}
function importBackup(file){ const reader=new FileReader(); reader.onload=e=>{ localStorage.setItem('labReports',e.target.result); alert('✅ Backup imported.'); }; reader.readAsText(file);}

// PDF download
async function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  const clone=byId('previewCard').cloneNode(true);
  ['techSig','clientSig'].forEach(id=>{ const canvas=byId(id); if(canvas){ const imgData=canvas.toDataURL(); const el=clone.querySelector('#'+id); if(el){ const img=document.createElement('img'); img.src=imgData; img.style.width=canvas.width+'px'; img.style.height=canvas.height+'px'; el.parentNode.replaceChild(img,el); }}});

  const canvas=await html2canvas(clone,{scale:1.5});
  const imgData=canvas.toDataURL('image/png');
  const imgProps=doc.getImageProperties(imgData);
  const pdfWidth=doc.internal.pageSize.getWidth()-40;
  const pdfHeight=(imgProps.height*pdfWidth)/imgProps.width;
  doc.addImage(imgData,'PNG',20,20,pdfWidth,pdfHeight);
  doc.save('LabReport.pdf');
}

// --- Events
testsList.addEventListener('change', renderResultInputs);
byId('btnAddCustom').addEventListener('click',()=>{const val=byId('customTest').value.trim();if(!val)return;const id='t_'+slug(val);const wrap=document.createElement('label');wrap.className='test-item';wrap.innerHTML=`<input type="checkbox" id="${id}" data-test="${val}" checked/> ${val}`;testsList.appendChild(wrap);byId('customTest').value='';renderResultInputs();});
byId('btnUpdate').addEventListener('click',updatePreview);
byId('btnSave').addEventListener('click',saveReport);
byId('btnView').addEventListener('click',showReports);
byId('btnExport').addEventListener('click',exportBackup);
byId('importFile').addEventListener('change',e=>importBackup(e.target.files[0]));
byId('btnDownload').addEventListener('click',downloadPDF);

// --- Init
renderResultInputs();
updatePreview();
</script>
</body>
</html>

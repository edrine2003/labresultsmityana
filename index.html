<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mobile Lab Mityana — Laboratory Report</title>
<style>
:root { --brand:#22c55e; --ink:#0f172a; --muted:#475569; --bg:#f1f5f9; --card:#fff; --border:#e2e8f0; }
*{box-sizing:border-box;}
body{margin:0;font-family:ui-sans-serif,system-ui,sans-serif;color:var(--ink);background:var(--bg);}
header{background:var(--brand);color:#fff;padding:12px 18px;}
header .title{font-weight:800;}
main{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;gap:16px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;}
h2{margin:0 0 10px;font-size:18px;}
.grid{display:grid;gap:10px;}
.g2{grid-template-columns:repeat(2,minmax(0,1fr));}
.g3{grid-template-columns:repeat(3,minmax(0,1fr));}
label small{color:var(--muted);display:block;margin-top:4px;}
input, select, textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;}
textarea{min-height:80px;}
.tests{columns:320px;column-gap:18px;}
.test-item{break-inside:avoid;display:flex;align-items:center;gap:8px;margin:6px 0;}
.btns{display:flex;flex-wrap:wrap;gap:8px;}
.btn{background:var(--brand);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;}
.btn.alt{background:#2563eb;}
.btn.ghost{background:#0f172a;}
.muted{color:var(--muted);}
.result-row{margin-bottom:10px;}
table{width:100%;border-collapse:collapse;margin-bottom:10px;font-size:12px;}
th, td{border:1px solid var(--border);padding:6px 8px;text-align:center;}
th{background:#f8fafc;}
tbody tr:nth-child(even){background:#f8fafc;}
.rep-head{padding:16px;border-bottom:1px solid var(--border);display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:12px;}
.rep-title{font-weight:800;font-size:20px;line-height:1.1;}
.rep-sub{color:var(--muted);font-size:12px;}
.rep-logo{width:56px;height:56px;border-radius:12px;border:1px solid var(--border);object-fit:cover;}
.rep-body{padding:16px;}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px;margin-bottom:12px;}
.kv div{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:10px 12px;}
.kv b{display:block;font-size:12px;color:var(--muted);margin-bottom:4px;}
.signs{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;}
.sigbox{height:64px;border:1px dashed var(--border);border-radius:10px;padding:8px;}
.stamp{border:4px solid #1e40af;color:#1e40af;padding:8px;text-align:center;margin-top:20px;border-radius:6px;width:250px;font-weight:700;}
.stamp-date{margin-top:5px;font-size:12px;}
@media print{@page{size:A4;margin:14mm;}header,.form,.btns{display:none !important;}body{background:#fff;}#previewCard{border:none;}}
</style>
</head>
<body>
<header>
  <div class="title">Mobile Lab Mityana — Laboratory Report System</div>
</header>
<main>
  <!-- Client -->
  <section class="card form">
    <h2>Client & Sample Details</h2>
    <div class="grid g3">
      <label>Client Name<input id="clientName" type="text" /></label>
      <label>Age<input id="age" type="number" /></label>
      <label>Gender<select id="gender"><option>Male</option><option>Female</option></select></label>
    </div>
    <div class="grid g3" style="margin-top:10px">
      <label>Lab ID<input id="sampleId" type="text" disabled/></label>
      <label>Technician<select id="technician"><option>Maweda Edrine</option><option>Matovu Timothy</option></select></label>
      <label>Date<input id="reportDate" type="text" disabled/></label>
    </div>
  </section>

  <!-- Tests -->
  <section class="card form">
    <h2>Select Tests</h2>
    <div id="testsList" class="tests"></div>
  </section>

  <!-- Results -->
  <section class="card form">
    <h2>Enter Results</h2>
    <div id="resultsContainer"></div>
    <div class="btns" style="margin-top:10px">
      <button id="btnUpdate" class="btn">Update Preview</button>
      <button id="btnDownload" class="btn alt">Download PDF</button>
      <button id="btnSave" class="btn ghost">Save Report</button>
      <button id="btnView" class="btn">View Saved Reports</button>
      <button id="btnExport" class="btn">Export Backup</button>
      <label class="btn alt" style="cursor:pointer">Import Backup
        <input type="file" id="importFile" style="display:none"/>
      </label>
    </div>
  </section>

  <!-- Preview -->
  <section id="previewCard" class="card">
    <div class="rep-head">
      <img class="rep-logo" src="icons/logo.png" alt="Lab Logo"/>
      <div>
        <div class="rep-title">Mobile Lab Mityana – Laboratory Report</div>
        <div class="rep-sub">Mityana, Uganda</div>
      </div>
      <div class="muted">Installable PWA</div>
    </div>
    <div class="rep-body" id="reportPreview">
      <p class="muted">Fill details and click <b>Update Preview</b>.</p>
    </div>
  </section>
</main>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const byId=id=>document.getElementById(id);

  // Auto Lab ID + Date
  const reports = JSON.parse(localStorage.getItem('labReports')||'[]');
  byId('sampleId').value = "LAB-" + (reports.length+1).toString().padStart(4,"0");
  byId('reportDate').value=new Date().toLocaleDateString();

  // Tests
  const TESTS=[
    "CBC – Complete Blood Count","HIV","Malaria","Blood Glucose","Blood Grouping","Lipid Profile","Liver Function","Kidney Function","PSA","Pregnancy (hCG)","Hepatitis B","Hepatitis C","Brucella","RPR","Chlamydia","Gonorrhea","Electrolytes","Rheumatoid Factor","H. Pylori (Serum)","H. Pylori (Stool)","Bleeding & Clotting (BAT)","Blood Smear"
  ];
  const CBC_FIELDS=["WBC","RBC","Hb","Hct","MCV","MCH","MCHC","PLT","LY","MO","GR","RDW-CV","RDW-SD","PCT","MPV","PDW","P-LCR"];
  const CBC_UNITS={"WBC":"10⁹/L","RBC":"10¹²/L","Hb":"g/dL","Hct":"%","MCV":"fL","MCH":"pg","MCHC":"g/dL","PLT":"10⁹/L","LY":"%","MO":"%","GR":"%","RDW-CV":"%","RDW-SD":"fL","PCT":"%","MPV":"fL","PDW":"fL","P-LCR":"%"};

  // Config
  const CONFIG={
    "CBC – Complete Blood Count":{type:"cbc"},
    "HIV":{type:"dropdown",options:["Negative","Positive"]},
    "Malaria":{type:"dropdown",options:["Negative","Positive"]},
    "Blood Glucose":{type:"number",unit:"mmol/L"},
    "Blood Grouping":{type:"dropdown",options:["A+","A-","B+","B-","O+","O-","AB+","AB-"]},
    "Pregnancy (hCG)":{type:"dropdown",options:["Negative","Positive"]},
    "Hepatitis B":{type:"dropdown",options:["Negative","Positive"]},
    "Hepatitis C":{type:"dropdown",options:["Negative","Positive"]},
    "Brucella":{type:"dropdown",options:["Negative","Positive"]},
    "RPR":{type:"dropdown",options:["Non-Reactive","Reactive"]},
    "Chlamydia":{type:"dropdown",options:["Negative","Positive"]},
    "Gonorrhea":{type:"dropdown",options:["Negative","Positive"]},
    "Electrolytes":{type:"textarea"},
    "Lipid Profile":{type:"textarea"},
    "Liver Function":{type:"textarea"},
    "Kidney Function":{type:"textarea"},
    "PSA":{type:"number",unit:"ng/mL"},
    "Rheumatoid Factor":{type:"dropdown",options:["Negative","Positive"]},
    "H. Pylori (Serum)":{type:"dropdown",options:["Negative","Positive"]},
    "H. Pylori (Stool)":{type:"dropdown",options:["Negative","Positive"]},
    "Bleeding & Clotting (BAT)":{type:"textarea"},
    "Blood Smear":{type:"textarea"}
  };

  // Render tests
  const testsList=byId('testsList');
  TESTS.forEach(test=>{
    const wrap=document.createElement('label');
    wrap.className='test-item';
    wrap.innerHTML=`<input type="checkbox" data-test="${test}"/> ${test}`;
    testsList.appendChild(wrap);
  });

  // Render inputs
  function renderResultInputs(){
    const container=byId('resultsContainer'); container.innerHTML='';
    [...testsList.querySelectorAll('input:checked')].forEach(cb=>{
      const test=cb.dataset.test; const cfg=CONFIG[test]||{type:'text'};
      if(cfg.type==='cbc'){
        let html='<h3>CBC Parameters</h3><table><thead><tr><th>Parameter</th><th>Value</th><th>Unit</th><th>Reference Range</th></tr></thead><tbody>';
        CBC_FIELDS.forEach(f=>{
          html+=`<tr>
            <td>${f}</td>
            <td><input type="text" id="res_${f}"/></td>
            <td>${CBC_UNITS[f]}</td>
            <td><input type="text" id="ref_${f}" placeholder="Normal range"/></td>
          </tr>`;
        });
        html+='</tbody></table>';
        container.innerHTML+=html;
      } else if(cfg.type==='dropdown'){
        container.innerHTML+=`<div class="result-row"><b>${test}</b><br><select id="res_${test}">${cfg.options.map(o=>`<option>${o}</option>`)}</select></div>`;
      } else if(cfg.type==='number'){
        container.innerHTML+=`<div class="result-row"><b>${test}</b><br><input type="number" id="res_${test}"/> ${cfg.unit||''}</div>`;
      } else if(cfg.type==='textarea'){
        container.innerHTML+=`<div class="result-row"><b>${test}</b><br><textarea id="res_${test}"></textarea></div>`;
      }
    });
  }

  // Collect results
  function collectResults(){
    const rows=[];
    [...testsList.querySelectorAll('input:checked')].forEach(cb=>{
      const test=cb.dataset.test; const cfg=CONFIG[test]||{type:'text'};
      if(cfg.type==='cbc'){
        let res={test:test,table:[]};
        CBC_FIELDS.forEach(f=>{
          const val=byId('res_'+f)?.value||'—';
          const ref=byId('ref_'+f)?.value||'—';
          res.table.push({param:f,val:val,unit:CBC_UNITS[f]||'',ref:ref});
        });
        rows.push(res);
      } else {
        const val=byId('res_'+test)?.value||'—';
        rows.push({test:test,result:val});
      }
    });
    return rows;
  }

  // Update Preview
  function updatePreview(){
    const rows=collectResults();
    let html=`<div class="kv">
      <div><b>Client</b>${byId('clientName').value}</div>
      <div><b>Age/Gender</b>${byId('age').value} / ${byId('gender').value}</div>
      <div><b>Lab ID</b>${byId('sampleId').value}</div>
      <div><b>Date</b>${byId('reportDate').value}</div>
    </div>`;

    rows.forEach(r=>{
      if(r.table){
        html+=`<h3>${r.test}</h3><table><thead><tr><th>Parameter</th><th>Value</th><th>Unit</th><th>Ref Range</th></tr></thead><tbody>`;
        r.table.forEach(t=>{html+=`<tr><td>${t.param}</td><td>${t.val}</td><td>${t.unit}</td><td>${t.ref}</td></tr>`});
        html+='</tbody></table>';
      } else {
        html+=`<p><b>${r.test}:</b> ${r.result}</p>`;
      }
    });

    byId('reportPreview').innerHTML=html;
  }

  // Save Report
  function saveReport(){
    const data=JSON.parse(localStorage.getItem('labReports')||'[]');
    data.push({client:byId('clientName').value,date:byId('reportDate').value,id:byId('sampleId').value,rows:collectResults()});
    localStorage.setItem('labReports',JSON.stringify(data));
    alert('✅ Report saved');
  }

  // View Reports
  function showReports(){
    const data=JSON.parse(localStorage.getItem('labReports')||'[]');
    if(!data.length){alert('No saved reports');return;}
    alert(data.map((r,i)=>`${i+1}. ${r.client} - ${r.date} (${r.id})`).join('\n'));
  }

  // Export / Import
  function exportBackup(){const blob=new Blob([localStorage.getItem('labReports')||'[]'],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='backup.json';a.click();}
  function importBackup(file){const reader=new FileReader();reader.onload=e=>{localStorage.setItem('labReports',e.target.result);alert('✅ Backup imported');};reader.readAsText(file);}

  // PDF
  async function downloadPDF(){
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF('p','pt','a4');
    await doc.html(byId('reportPreview'),{callback:function(pdf){pdf.save('LabReport.pdf');},x:20,y:20,width:555});
  }

  // Events
  testsList.addEventListener('change',renderResultInputs);
  byId('btnUpdate').addEventListener('click',updatePreview);
  byId('btnSave').addEventListener('click',saveReport);
  byId('btnView').addEventListener('click',showReports);
  byId('btnExport').addEventListener('click',exportBackup);
  byId('importFile').addEventListener('change',e=>importBackup(e.target.files[0]));
  byId('btnDownload').addEventListener('click',downloadPDF);
});
</script>
</body>
</html>
